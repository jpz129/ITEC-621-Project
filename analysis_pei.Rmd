---
title: "EDA"
author: "Pei-Hsin Lin"
date: "3/30/2021"
output: pdf_document
---

```{r}
library(tidyverse)
data <- read_csv("data/project_data.csv")[,c(2,3,4,5,6,8,11,35)]
data <- na.omit(data)
head(data) # 13804 rows
names(data)
unique(data$date)
# unique(data$county_fips) # 986
unique(data$state) # 51
```

```{r}
summary(data)
```


```{r}
data$region <- 0
for (i in 1:nrow(data)) {
  if (data$state[i] %in% c("connecticut","maine","massachusetts","new hampshire","rhode island", "vermont")) {
    data$region[i] <- 1
  } else if (data$state[i] %in% c("new jersey", "new york", "puerto rico")) {
    data$region[i] <- 2
  } else if (data$state[i] %in% c("delaware", "district of columbia", "maryland", "pennsylvania", "virginia", "west virginia")) {
    data$region[i] <- 3
  } else if (data$state[i] %in% c("alabama", "florida", "georgia", "kentucky", "mississippi", "north carolina", "south carolina", "tennessee")) {
    data$region[i] <- 4
  } else if (data$state[i] %in% c("illinois", "indiana", "michigan", "minnesota", "ohio", "wisconsin")) {
    data$region[i] <- 5
  } else if (data$state[i] %in% c("arkansas", "louisiana", "new mexico", "oklahoma", "texas")) {
    data$region[i] <- 6
  } else if (data$state[i] %in% c("iowa", "kansas", "missouri", "nebraska")) {
    data$region[i] <- 7
  } else if (data$state[i] %in% c("colorado", "montana", "north dakota", "south dakota", "utah", "wyoming")) {
    data$region[i] <- 8
  } else if (data$state[i] %in% c("arizona", "california", "hawaii", "nevada", "american samoa", "guam", "northern mariana islands")) {
    data$region[i] <- 9
  } else if (data$state[i] %in% c( "alaska", "idaho", "oregon", "washington")) {
    data$region[i] <- 10
  }
}
data$region <- as.factor(data$region)
# Region I: Connecticut, Maine, Massachusetts, New Hampshire, Rhode Island, Vermont
# Region II: New Jersey, New York, Puerto Rico, US Virgin Islands
# Region III: Delaware, District of Columbia, Maryland, Pennsylvania, Virginia, West Virginia
# Region IV: Alabama, Florida, Georgia, Kentucky, Mississippi, North Carolina, South Carolina, Tennessee
# Region V: Illinois, Indiana, Michigan, Minnesota, Ohio, Wisconsin
# Region VI: Arkansas, Louisiana, New Mexico, Oklahoma, Texas
# Region VII: Iowa, Kansas, Missouri, Nebraska
# Region VIII: Colorado, Montana, North Dakota, South Dakota, Utah, Wyoming
# Region IX: Arizona, California, Hawaii, Nevada, American Samoa, Guam, Northern Mariana Islands
# Region X: Alaska, Idaho, Oregon, Washington
head(data)
```


# EDA
1. Does the monthly amount of covid cases affect the listing price over states?
- It seems that covid case amount might affect the listing price. 
- We can then build regression model: listing~covid_cases

```{r}
library(ggplot2)
```

```{r}
ggplot(aes(x=cases, y=median_listing_price), data=data) + 
  geom_point() + geom_smooth() 
```

```{r}
ggplot(aes(x=cases, y=median_listing_price), data=data) + 
  geom_point() + geom_smooth() +
  facet_grid(rows = vars(region))
```


2. When does the trend of covid start to slow down? 
   Does monthly housing inventory decrease when the covid cases increase?
- Overall, it seems that the covid trend starts to slow down since May 2020, but it starts to increase faster after the end of 2020.
- It seems that monthly housing inventory increases when the covid cases increase.

```{r}
# covid trend over states
ggplot(aes(x=date, y=cases), data=data) +
  geom_jitter() + geom_smooth()
```

```{r}
ggplot(aes(x=date, y=cases), data=data) + 
  geom_point() + geom_smooth() +
  facet_grid(cols = vars(region)) +
  theme(axis.text.x=element_text(angle=45))
```

```{r}
data%>%
  group_by(date,region)%>%
  summarise(Covid_Cases=mean(cases))%>%
  ungroup()%>%
  ggplot(aes(
    x=date,
    y=Covid_Cases,
    colour=region,
    group=region,
    shape=region
    ))+
  geom_line()+
  geom_point(size=4)
```

```{r}
data%>%
  group_by(date,region)%>%
  summarise(mlp=mean(median_listing_price))%>%
  ungroup()%>%
  ggplot(aes(
    x=date,
    y=mlp,
    colour=region,
    group=region,
    shape=region
    ))+
  geom_line()+
  geom_point(size=4)

data%>%
  group_by(date,region)%>%
  summarise(alc=mean(active_listing_count))%>%
  ungroup()%>%
  ggplot(aes(
    x=date,
    y=alc,
    colour=region,
    group=region,
    shape=region
    ))+
  geom_line()+
  geom_point(size=4)

```
```{r}
data%>%
  group_by(date,region)%>%
  summarise(Covid_Cases=mean(cases), mlp=mean(median_listing_price))%>%
  ungroup()%>%
  ggplot(aes(
        x = Covid_Cases,
        y = mlp,
        col = region
        )) +
       geom_point(mapping = aes(size = mlp)) +
      geom_point(aes(size = Covid_Cases)) +
      scale_size(range = c(1, 20), guide = FALSE) +
      scale_x_discrete(aes(label = Covid_Cases)) +
      scale_color_brewer(palette = "Set3")
```

3a. Time series for listing price (Year â†’ Month)
    Can the listing price in months of 2020 be predicted by the former period?    
    - It seems that there is a positive trend for listing price, but we will have to run the time series model. 

```{r}
data%>%
  group_by(date)%>%
  summarise(price=mean(median_listing_price))%>%
  ggplot(aes(
    x=date,
    y=price,
  ))+
  geom_point()+
  geom_line()+
  theme(axis.text.x=element_text(angle=45))
```
 
3b. Regression (listing price prediction)

- We can first see correlation relationship between different variables. Compared to other variables, cases and death have stronger correlation with listing count and price. 

- We also find the correlation between average listing count and average listing price is stronger than other relationships. That means the average number of for sale properties may have effects on the average listing price.

- Surprisingly, county and state do not have strong correlation with other variables, but region does have good positive correlation with listing price.

```{r}
data$region <- as.numeric(data$region)
data$state <- as.numeric(as.factor(data$state))
data$county <- as.numeric(as.factor(data$county))
X<-data[,-1]
M<-cor(X)
library(corrplot)
corrplot(M, method="shade")
corrplot(M, method="number")
```
-- regression
-- regression tree
Then, we would like to know whether covid significantly affects the listing price yearly?
- yearly_listing_price ~ covid_case(1/0)
If yes, we could also explore the effect of covid on monthly listing price for the whole U.S.
- monthly_listing_price ~ covid_case(quant)
 
Then, we want to know if there are any other factors contributing to the monthly listing price 
for the US and each state.
- monthly_listing_price ~ population(quant or rank)+covid_case(quant)+covid_death
- monthly_listing_price ~ state+population(quant or rank)+covid_case(quant)+covid_death
```{r}
full.lm.fit<-lm(active_listing_count~cases+deaths+county+state+region,data = data)
summary(full.lm.fit)
```

```{r}
full.lm.fit<-lm(active_listing_count~cases+deaths+county+state+region+average_listing_price,data = data)
summary(full.lm.fit)
```

```{r}

```
 
3c. Classification:
We can then divide monthly listing price into two/three levels (high,medium,low), and see 
how the factors affect the listing price level.
-- logistic regression
-- classification tree
- yearly_listing_price_level ~ covid_case(1/0)
- monthly_listing_price_level ~ covid_case(quant)
- monthly_listing_price_level ~ population(quant or rank)+covid_case(quant)+covid_death
- monthly_listing_price_level ~ state+population(quant or rank)+covid_case(quant)+covid_death











